# Copyright 2020 The Khronos Group Inc.
# SPDX-License-Identifier: Apache-2.0

# Output specification targets
SPEC = Specification
TARGETS = $(SPEC).html $(SPEC).pdf
all: $(TARGETS)

# Generate the Properties Reference section of the spec from JSON schema.
# This uses 'npx' to minimally install the 'wetzel' tool, if needed.
# When using embedded schemas, SCHEMALINK should be a relative path.

# Note this Makefile should remain locked to a particular version of
# wetzel, such that the history of changes to the documentation can
# accurately reflect changes to wetzel that impact the output here.
# Please manually upgrade the version as often as needed, without unlocking.

WETZEL = npx wetzel@0.2.1
SCHEMALINK = schema
EMBEDSCHEMA = JsonSchemaReference.adoc

# Base name of the generated properties reference file
PROPREF = PropertiesReference
# Files generated by wetzel
GENERATED = $(PROPREF).adoc $(EMBEDSCHEMA)
# Schema files to leave out of $(PROPREF)
IGNORESCHEMA = '["gltfchildofrootproperty.schema.json", "gltfid.schema.json", "gltfproperty.schema.json"]'
$(GENERATED): $(wildcard schema/*.json)
	$(WETZEL) -n -a=cqo -m=a -p "$(SCHEMALINK)" -e "$(EMBEDSCHEMA)" \
	    -i $(IGNORESCHEMA) -c "icon:check[]" -k "**MUST**"\
	    schema/glTF.schema.json > $(PROPREF).adoc

# Spec targets for offline generation
# Requires an up-to-date asciidoctor, asciidoctor-pdf, and
# asciidoctor-mathematical be installed
# We recommend using the khronosgroup/vulkan-docs-base image on dockerhub
ASCIIDOCTOR = asciidoctor $(ADOCOPTS)
ADOCOPTS = -d book
SPECDEPS = $(SPEC).adoc $(GENERATED)

$(SPEC).html: $(SPECDEPS)
	$(ASCIIDOCTOR) -b html5 $(SPEC).adoc -o $@

# :allow-url-read: is necessary for the embedded render.githubusers.com
# math images to be processed for the PDF target. See
# https://github.com/asciidoctor/asciidoctor-pdf/issues/369
# asciidoctor-mathematical leaves intermediate images of equations behing.
# These are removed after creating the PDF.
STEMIMAGES = stem-*.png
$(SPEC).pdf: $(SPECDEPS)
	$(ASCIIDOCTOR) -b pdf -a allow-uri-read -r asciidoctor-pdf \
	    -r asciidoctor-mathematical $(SPEC).adoc -o $@
	rm -f $(STEMIMAGES)

clean:
	-rm -f $(GENERATED) $(TARGETS)
